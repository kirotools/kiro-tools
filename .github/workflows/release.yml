name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: webui/package-lock.json

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build backend
        run: cargo build --release

      - name: Build frontend
        working-directory: webui
        run: npm install --legacy-peer-deps && npm run build

      - name: Package tarball
        run: |
          mkdir -p release/kiro-tools-linux-amd64
          cp target/release/kiro-tools release/kiro-tools-linux-amd64/
          cp -r webui/dist release/kiro-tools-linux-amd64/dist
          cp README.md LICENSE Dockerfile release/kiro-tools-linux-amd64/
          cd release && tar czf kiro-tools-linux-amd64.tar.gz kiro-tools-linux-amd64

      - name: Package deb
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          VERSION="${VERSION:-0.1.0}"
          PKG_DIR="release/deb/kiro-tools_${VERSION}_amd64"
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/kiro-tools/dist"
          mkdir -p "${PKG_DIR}/lib/systemd/system"
          mkdir -p "${PKG_DIR}/etc/kiro-tools"

          cp target/release/kiro-tools "${PKG_DIR}/usr/bin/"
          cp -r webui/dist/* "${PKG_DIR}/usr/share/kiro-tools/dist/"

          # --- control ---
          cat > "${PKG_DIR}/DEBIAN/control" << 'CTRL'
          Package: kiro-tools
          Version: VERSIONPLACEHOLDER
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libc6, libssl3 | libssl1.1, ca-certificates
          Maintainer: you
          Description: Kiro Tools - Anthropic compatible proxy with multi-account rotation
           Standalone proxy server providing Anthropic /v1/messages API
           with multi-account rotation, WebUI management, and credits tracking.
          CTRL
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/control"
          sed -i "s/VERSIONPLACEHOLDER/${VERSION}/" "${PKG_DIR}/DEBIAN/control"

          # --- conffiles ---
          cat > "${PKG_DIR}/DEBIAN/conffiles" << 'CONF'
          /etc/kiro-tools/env
          CONF
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/conffiles"

          # --- postinst ---
          cat > "${PKG_DIR}/DEBIAN/postinst" << 'POSTINST'
          #!/bin/sh
          set -e
          if [ "$1" = "configure" ]; then
              systemctl daemon-reload || true
              echo ""
              echo "============================================"
              echo "  kiro-tools 安装完成"
              echo "============================================"
              echo ""
              echo "  配置凭证:"
              echo "    编辑 /etc/kiro-tools/env 设置 KIRO_CREDS_FILE"
              echo ""
              echo "  启动服务:"
              echo "    sudo systemctl start kiro-tools"
              echo "    sudo systemctl enable kiro-tools"
              echo ""
              echo "  查看日志:"
              echo "    journalctl -u kiro-tools -f"
              echo "============================================"
          fi
          POSTINST
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/postinst"
          chmod 755 "${PKG_DIR}/DEBIAN/postinst"

          # --- prerm ---
          cat > "${PKG_DIR}/DEBIAN/prerm" << 'PRERM'
          #!/bin/sh
          set -e
          if [ "$1" = "remove" ] || [ "$1" = "deconfigure" ]; then
              if systemctl is-active --quiet kiro-tools 2>/dev/null; then
                  echo "停止 kiro-tools 服务..."
                  systemctl stop kiro-tools || true
              fi
              if systemctl is-enabled --quiet kiro-tools 2>/dev/null; then
                  systemctl disable kiro-tools || true
              fi
          fi
          PRERM
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/prerm"
          chmod 755 "${PKG_DIR}/DEBIAN/prerm"

          # --- postrm ---
          cat > "${PKG_DIR}/DEBIAN/postrm" << 'POSTRM'
          #!/bin/sh
          set -e
          if [ "$1" = "purge" ]; then
              rm -rf /etc/kiro-tools
          fi
          systemctl daemon-reload || true
          POSTRM
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/postrm"
          chmod 755 "${PKG_DIR}/DEBIAN/postrm"

          # --- 默认环境变量文件 ---
          cat > "${PKG_DIR}/etc/kiro-tools/env" << 'ENVFILE'
          # Kiro Tools 环境变量配置
          # 取消注释并修改以下配置项

          # 凭证文件路径 (必需)
          #KIRO_CREDS_FILE=/path/to/kiro-auth-token.json

          # 监听端口 (默认 8045)
          #KIRO_PORT=8045
          ENVFILE
          sed -i 's/^          //' "${PKG_DIR}/etc/kiro-tools/env"

          # --- systemd service ---
          cat > "${PKG_DIR}/lib/systemd/system/kiro-tools.service" << 'SVC'
          [Unit]
          Description=Kiro Tools Proxy Server
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          Environment=KIRO_DIST_PATH=/usr/share/kiro-tools/dist
          EnvironmentFile=-/etc/kiro-tools/env
          ExecStart=/usr/bin/kiro-tools
          Restart=on-failure
          RestartSec=5
          LimitNOFILE=65536

          [Install]
          WantedBy=multi-user.target
          SVC
          sed -i 's/^          //' "${PKG_DIR}/lib/systemd/system/kiro-tools.service"

          dpkg-deb --build "${PKG_DIR}"
          mv "release/deb/kiro-tools_${VERSION}_amd64.deb" release/

      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: kiro-tools-linux-amd64-tarball
          path: release/kiro-tools-linux-amd64.tar.gz

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: kiro-tools-linux-amd64-deb
          path: release/*.deb

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: webui/package-lock.json

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build backend
        run: cargo build --release

      - name: Build frontend
        working-directory: webui
        run: npm install --legacy-peer-deps && npm run build

      - name: Package zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release/kiro-tools-windows-amd64
          Copy-Item target/release/kiro-tools.exe release/kiro-tools-windows-amd64/
          Copy-Item -Recurse webui/dist release/kiro-tools-windows-amd64/dist
          Copy-Item README.md, LICENSE release/kiro-tools-windows-amd64/
          Compress-Archive -Path release/kiro-tools-windows-amd64 -DestinationPath release/kiro-tools-windows-amd64.zip

      - name: Upload zip
        uses: actions/upload-artifact@v4
        with:
          name: kiro-tools-windows-amd64-zip
          path: release/kiro-tools-windows-amd64.zip

  publish:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          allowUpdates: true
          name: "Kiro Tools ${{ github.ref_name }}"
          generateReleaseNotes: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "artifacts/**/*.tar.gz,artifacts/**/*.deb,artifacts/**/*.zip"
          artifactErrorsFailBuild: false
          replacesArtifacts: true
          makeLatest: legacy
