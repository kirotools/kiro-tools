name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: webui/package-lock.json

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build backend
        run: cargo build --release

      - name: Build frontend
        working-directory: webui
        run: npm install --legacy-peer-deps && npm run build

      - name: Package tarball
        run: |
          mkdir -p release/kiro-tools-linux-amd64
          cp target/release/kiro-tools release/kiro-tools-linux-amd64/
          cp -r webui/dist release/kiro-tools-linux-amd64/dist
          cp README.md LICENSE Dockerfile start.sh release/kiro-tools-linux-amd64/
          cd release && tar czf kiro-tools-linux-amd64.tar.gz kiro-tools-linux-amd64

      - name: Package deb
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          VERSION="${VERSION:-0.1.0}"
          PKG_DIR="release/deb/kiro-tools_${VERSION}_amd64"
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/kiro-tools/dist"
          mkdir -p "${PKG_DIR}/lib/systemd/system"
          mkdir -p "${PKG_DIR}/etc/kiro-tools"

          cp target/release/kiro-tools "${PKG_DIR}/usr/bin/"
          cp -r webui/dist/* "${PKG_DIR}/usr/share/kiro-tools/dist/"

          # --- control ---
          cat > "${PKG_DIR}/DEBIAN/control" << 'CTRL'
          Package: kiro-tools
          Version: VERSIONPLACEHOLDER
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libc6, libssl3 | libssl1.1, ca-certificates
          Maintainer: you
          Description: Kiro Tools - Anthropic compatible proxy with multi-account rotation
           Standalone proxy server providing Anthropic /v1/messages API
           with multi-account rotation, WebUI management, and credits tracking.
          CTRL
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/control"
          sed -i "s/VERSIONPLACEHOLDER/${VERSION}/" "${PKG_DIR}/DEBIAN/control"

          # --- conffiles ---
          cat > "${PKG_DIR}/DEBIAN/conffiles" << 'CONF'
          /etc/kiro-tools/env
          CONF
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/conffiles"

          # --- postinst ---
          cat > "${PKG_DIR}/DEBIAN/postinst" << 'POSTINST'
          #!/bin/sh
          set -e
          if [ "$1" = "configure" ]; then
              # Create dedicated system user if not exists
              if ! getent passwd kiro-tools >/dev/null 2>&1; then
                  adduser --system --group --home /var/lib/kiro-tools --no-create-home --shell /usr/sbin/nologin kiro-tools || true
              fi
              # Ensure data directory exists with correct ownership
              mkdir -p /var/lib/kiro-tools
              chown kiro-tools:kiro-tools /var/lib/kiro-tools
              chmod 750 /var/lib/kiro-tools
              systemctl daemon-reload || true
              echo ""
              echo "============================================"
              echo "  kiro-tools 安装完成"
              echo "============================================"
              echo ""
              echo "  添加账号:"
              echo "    启动后访问 WebUI http://localhost:8045 添加账号"
              echo ""
              echo "  启动服务:"
              echo "    sudo systemctl start kiro-tools"
              echo "    sudo systemctl enable kiro-tools"
              echo ""
              echo "  查看日志:"
              echo "    journalctl -u kiro-tools -f"
              echo ""
              echo "  数据目录: /var/lib/kiro-tools"
              echo "============================================"
          fi
          POSTINST
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/postinst"
          chmod 755 "${PKG_DIR}/DEBIAN/postinst"

          # --- prerm ---
          cat > "${PKG_DIR}/DEBIAN/prerm" << 'PRERM'
          #!/bin/sh
          set -e
          if [ "$1" = "remove" ] || [ "$1" = "deconfigure" ]; then
              if systemctl is-active --quiet kiro-tools 2>/dev/null; then
                  echo "停止 kiro-tools 服务..."
                  systemctl stop kiro-tools || true
              fi
              if systemctl is-enabled --quiet kiro-tools 2>/dev/null; then
                  systemctl disable kiro-tools || true
              fi
          fi
          PRERM
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/prerm"
          chmod 755 "${PKG_DIR}/DEBIAN/prerm"

          # --- postrm ---
          cat > "${PKG_DIR}/DEBIAN/postrm" << 'POSTRM'
          #!/bin/sh
          set -e
          if [ "$1" = "purge" ]; then
              rm -rf /etc/kiro-tools
              rm -rf /var/lib/kiro-tools
              # Remove system user
              if getent passwd kiro-tools >/dev/null 2>&1; then
                  deluser --system kiro-tools || true
              fi
              if getent group kiro-tools >/dev/null 2>&1; then
                  delgroup --system kiro-tools || true
              fi
          fi
          systemctl daemon-reload || true
          POSTRM
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/postrm"
          chmod 755 "${PKG_DIR}/DEBIAN/postrm"

          # --- 默认环境变量文件 ---
          cat > "${PKG_DIR}/etc/kiro-tools/env" << 'ENVFILE'
          # Kiro Tools 环境变量配置
          # 取消注释并修改以下配置项

          # 数据目录 (默认 /var/lib/kiro-tools，由 postinst 创建)
          # 如需自定义请确保目录存在且 kiro-tools 用户有读写权限
          #KIRO_DATA_DIR=/var/lib/kiro-tools

          # 监听端口 (默认 8045)
          #KIRO_PORT=8045

          # API 密钥 (可选，默认自动生成)
          #KIRO_API_KEY=sk-your-api-key

          # Web UI 密码 (可选，默认与 API Key 相同)
          #KIRO_WEB_PASSWORD=your-password

          # 认证模式 (可选: off, strict, all_except_health, auto)
          #KIRO_AUTH_MODE=all_except_health

          # 是否仅本地访问 (true=仅127.0.0.1, false=允许局域网0.0.0.0)
          #KIRO_BIND_LOCAL_ONLY=false

          # Cloudflare Tunnel (quick=临时URL, 或填入token使用认证隧道)
          #KIRO_CF_TUNNEL=quick
          # 自动安装 cloudflared (true=自动下载安装)
          #KIRO_CF_AUTO_INSTALL=true
          ENVFILE
          sed -i 's/^          //' "${PKG_DIR}/etc/kiro-tools/env"

          # --- systemd service ---
          cat > "${PKG_DIR}/lib/systemd/system/kiro-tools.service" << 'SVC'
          [Unit]
          Description=Kiro Tools Proxy Server
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=kiro-tools
          Group=kiro-tools
          WorkingDirectory=/var/lib/kiro-tools
          Environment=KIRO_DIST_PATH=/usr/share/kiro-tools/dist
          Environment=KIRO_DATA_DIR=/var/lib/kiro-tools
          EnvironmentFile=-/etc/kiro-tools/env
          ExecStart=/usr/bin/kiro-tools
          Restart=on-failure
          RestartSec=5
          LimitNOFILE=65536

          # Security hardening
          NoNewPrivileges=true
          ProtectSystem=strict
          ReadWritePaths=/var/lib/kiro-tools
          ProtectHome=true
          PrivateTmp=true

          [Install]
          WantedBy=multi-user.target
          SVC
          sed -i 's/^          //' "${PKG_DIR}/lib/systemd/system/kiro-tools.service"

          dpkg-deb --build "${PKG_DIR}"
          mv "release/deb/kiro-tools_${VERSION}_amd64.deb" release/

      - name: Smoke test deb package
        run: |
          set -euo pipefail
          DEB_PATH=$(ls release/*.deb | head -n 1)
          test -f "$DEB_PATH"

          SMOKE_DIR="/tmp/kiro-deb-smoke"
          rm -rf "$SMOKE_DIR"
          mkdir -p "$SMOKE_DIR"
          dpkg-deb -x "$DEB_PATH" "$SMOKE_DIR"

          test -x "$SMOKE_DIR/usr/bin/kiro-tools"
          test -d "$SMOKE_DIR/usr/share/kiro-tools/dist"

          LOG_FILE="/tmp/kiro-deb-smoke.log"
          DATA_DIR="/tmp/kiro-deb-smoke-data"
          rm -rf "$DATA_DIR" && mkdir -p "$DATA_DIR"

          KIRO_PORT=18045 \
          KIRO_BIND_LOCAL_ONLY=true \
          KIRO_DIST_PATH="$SMOKE_DIR/usr/share/kiro-tools/dist" \
          KIRO_DATA_DIR="$DATA_DIR" \
          timeout 8s "$SMOKE_DIR/usr/bin/kiro-tools" >"$LOG_FILE" 2>&1 || rc=$?
          if [ "${rc:-0}" -ne 0 ] && [ "${rc:-0}" -ne 124 ]; then
            cat "$LOG_FILE"
            exit "${rc}"
          fi

          if ! grep -Eq "Proxy service starting|反代服务器启动" "$LOG_FILE"; then
            cat "$LOG_FILE"
            echo "Smoke test failed: kiro-tools did not reach startup logs"
            exit 1
          fi

          # Verify WebUI dist is included and has content
          if [ ! -f "$SMOKE_DIR/usr/share/kiro-tools/dist/index.html" ]; then
            echo "Smoke test failed: WebUI dist/index.html not found"
            ls -la "$SMOKE_DIR/usr/share/kiro-tools/dist/" 2>/dev/null || echo "dist dir missing"
            exit 1
          fi
          echo "Smoke test passed: binary starts, logs ok, WebUI dist present"

      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: kiro-tools-linux-amd64-tarball
          path: release/kiro-tools-linux-amd64.tar.gz

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: kiro-tools-linux-amd64-deb
          path: release/*.deb

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: webui/package-lock.json

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build backend
        run: cargo build --release

      - name: Build frontend
        working-directory: webui
        run: npm install --legacy-peer-deps && npm run build

      - name: Package zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release/kiro-tools-windows-amd64
          Copy-Item target/release/kiro-tools.exe release/kiro-tools-windows-amd64/
          Copy-Item -Recurse webui/dist release/kiro-tools-windows-amd64/dist
          Copy-Item README.md, LICENSE, start.ps1 release/kiro-tools-windows-amd64/
          Compress-Archive -Path release/kiro-tools-windows-amd64 -DestinationPath release/kiro-tools-windows-amd64.zip

      - name: Smoke test windows exe
        shell: pwsh
        run: |
          $exe = "target/release/kiro-tools.exe"
          if (!(Test-Path $exe)) {
            throw "Windows executable not found: $exe"
          }

          $env:KIRO_PORT = "18045"
          $env:KIRO_BIND_LOCAL_ONLY = "true"
          $stdoutLog = Join-Path $env:RUNNER_TEMP "kiro-exe-smoke.stdout.log"
          $stderrLog = Join-Path $env:RUNNER_TEMP "kiro-exe-smoke.stderr.log"

          $proc = Start-Process -FilePath $exe -PassThru -RedirectStandardOutput $stdoutLog -RedirectStandardError $stderrLog
          Start-Sleep -Seconds 8

          if ($proc.HasExited) {
            Get-Content $stdoutLog -ErrorAction SilentlyContinue
            Get-Content $stderrLog -ErrorAction SilentlyContinue
            throw "Smoke test failed: kiro-tools.exe exited early with code $($proc.ExitCode)"
          }

          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue

      - name: Upload zip
        uses: actions/upload-artifact@v4
        with:
          name: kiro-tools-windows-amd64-zip
          path: release/kiro-tools-windows-amd64.zip

  publish:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          allowUpdates: true
          name: "Kiro Tools ${{ github.ref_name }}"
          generateReleaseNotes: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "artifacts/**/*.tar.gz,artifacts/**/*.deb,artifacts/**/*.zip"
          artifactErrorsFailBuild: false
          replacesArtifacts: true
          makeLatest: legacy
